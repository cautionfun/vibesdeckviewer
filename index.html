<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibes Deck Viewer</title>
    <style>
        :root {
            --bg-main: #050711;
            --bg-panel: #101320;
            --bg-deck: #090b15;
            --accent: #7b5cff;
            --accent-soft: rgba(123, 92, 255, 0.15);
            --text-main: #f5f5ff;
            --text-muted: #a0a4c0;
            --border-subtle: #22263a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #151a35 0, #050711 55%);
            color: var(--text-main);
        }

        nav {
            text-align: center;
            padding: 12px 16px;
            border-bottom: 1px solid #14182a;
            background: #050814;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav a {
            text-decoration: none;
            font-size: 15px;
            margin: 0 10px;
            color: var(--text-muted);
        }

        nav a:hover {
            color: var(--accent);
        }

        main.page {
            display: flex;
            gap: 16px;
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 24px;
        }

        h2 {
            margin: 4px 0 10px;
            font-size: 18px;
        }

        .viewer-section {
            flex: 3;
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .input-section {
            margin-bottom: 12px;
        }

        .input-label {
            font-size: 13px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
        }

        #deckInput {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: #080b19;
            color: var(--text-main);
            font-size: 13px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        #deckInput::placeholder {
            color: #626781;
        }

        #deckInput:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .button-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .button-row button {
            border-radius: 8px;
            border: none;
            padding: 7px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.12s ease-out, transform 0.06s ease-out, box-shadow 0.12s ease-out;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7b5cff, #f05fff);
            color: white;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.55);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.66);
        }

        .btn-secondary {
            background: #171b2b;
            color: var(--text-main);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            background: #1f2436;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .helper-text {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .deck-header-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin: 10px 0 8px;
        }

        #deckName {
            font-size: 18px;
            font-weight: 600;
        }

        #deckCountDisplay {
            font-size: 13px;
            color: var(--text-muted);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .card {
            text-align: center;
            position: relative;
            background: #111428;
            border-radius: 10px;
            padding: 8px 6px 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .card img {
            width: 100%;
            max-width: 150px;
            border-radius: 6px;
            background-color: #050713;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.6);
        }

        .card:hover img {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.75);
        }

        .card p {
            margin-top: 6px;
            font-size: 13px;
            color: var(--text-main);
            font-weight: 500;
        }

        .charts-section {
            flex: 2;
            background: var(--bg-deck);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: calc(100vh - 32px);
        }

        .deck-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chart-wrapper {
            flex: 1;
            border-radius: 10px;
            border: 1px solid #15192c;
            background: #050713;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .chart-container {
            flex: 1;
            min-height: 0;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #cardTooltip {
            position: fixed;
            pointer-events: none;
            display: none;
            background: #050713;
            border-radius: 8px;
            border: 1px solid #34385c;
            padding: 6px 8px;
            font-size: 11px;
            color: var(--text-main);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
            max-width: 240px;
            z-index: 9999;
        }

        #cardTooltip .tooltip-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
        }

        #cardTooltip .tooltip-line {
            font-size: 11px;
        }

        #cardPreview {
            position: absolute;
            pointer-events: none;
            max-width: 260px;
            max-height: 380px;
            display: none;
            border: 2px solid #3a3f63;
            background: #050713;
            z-index: 9998;
            border-radius: 10px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
        }

        @media (max-width: 1000px) {
            main.page {
                flex-direction: column;
            }
            .charts-section {
                max-height: none;
            }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav>
        <a href="index.html">Deck Viewer</a> |
        <a href="deckbuilder.html">Deck Builder</a> |
        <a href="openpacks.html">Pack Simulator</a>
    </nav>

    <main class="page">
        <section class="viewer-section">
            <h1>Vibes Deck Viewer</h1>

            <div class="input-section">
                <label for="deckInput" class="input-label">Paste your deck code:</label>
                <input
                    type="text"
                    id="deckInput"
                    placeholder='{"deckName":"DeckName","counts":{"CardId":3}}'
                >
                <div class="button-row">
                    <button class="btn-primary" onclick="renderDeck(document.getElementById('deckInput').value)">Submit</button>
                    <button class="btn-secondary" onclick="clearDeck()">Clear</button>
                </div>
                <div class="helper-text">
                    Tip: you can also open this page with a <code>?deck=...</code> URL, or press Enter in the box to render.
                </div>
            </div>

            <div class="deck-header-row">
                <h2 id="deckName"></h2>
                <div id="deckCountDisplay"></div>
            </div>

            <div class="card-grid" id="cardGrid"></div>
        </section>

        <section class="charts-section">
            <div class="deck-breakdown-header">
                <h2>Deck Breakdown</h2>
                <button class="btn-secondary btn-small" onclick="openInDeckBuilder()">Open in Deck Builder</button>
            </div>

            <div class="chart-wrapper">
                <div class="chart-title">Cards by Type</div>
                <div class="chart-container"><canvas id="typeChart"></canvas></div>
            </div>

            <div class="chart-wrapper">
                <div class="chart-title">Cards by Color</div>
                <div class="chart-container"><canvas id="colorChart"></canvas></div>
            </div>

            <div class="chart-wrapper">
                <div class="chart-title">Cost Distribution (Penguin / Relic)</div>
                <div class="chart-container"><canvas id="costChart"></canvas></div>
            </div>
        </section>
    </main>

    <div id="cardTooltip">
        <div class="tooltip-name" id="tooltipName"></div>
        <div class="tooltip-line" id="tooltipType"></div>
        <div class="tooltip-line" id="tooltipColor"></div>
        <div class="tooltip-line" id="tooltipCost"></div>
    </div>

    <img id="cardPreview" src="" alt="Card Preview">

    <script>
        let allCards = [];
        let lastDeckJSON = "";

        const cardsReady = fetch('vibes_cards.json')
            .then(res => res.json())
            .then(data => { allCards = data; })
            .catch(err => console.error('Failed to load card data:', err));

        const deckInput = document.getElementById("deckInput");
        const cardTooltip = document.getElementById("cardTooltip");
        const tooltipName = document.getElementById("tooltipName");
        const tooltipType = document.getElementById("tooltipType");
        const tooltipColor = document.getElementById("tooltipColor");
        const tooltipCost = document.getElementById("tooltipCost");
        const cardPreview = document.getElementById("cardPreview");

        deckInput.addEventListener("keypress", async (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                await cardsReady;
                renderDeck(deckInput.value);
            }
        });

        function clearDeck() {
            deckInput.value = "";
            document.getElementById('cardGrid').innerHTML = "";
            document.getElementById('deckName').textContent = "";
            document.getElementById('deckCountDisplay').textContent = "";
            lastDeckJSON = "";
            hideCardTooltip();
            hideCardImage();
            [typeChart, colorChart, costChart].forEach(chart => chart && chart.destroy && chart.destroy());
        }

        function getEffectiveCost(card) {
            if (card.cost && typeof card.cost.amount === 'number') {
                return card.cost.amount;
            }

            if (
                card.type === 'Action' &&
                card.pudge &&
                typeof card.pudge.amount === 'number' &&
                typeof card.color === 'string'
            ) {
                const colors = card.color.split(',').map(c => c.trim()).filter(Boolean);
                if (colors.length > 0) {
                    return card.pudge.amount * colors.length;
                }
            }

            return null;
        }

        function showCardTooltip(cardId, event) {
            const card = allCards.find(c => c.id === cardId);
            if (!card) return;

            tooltipName.textContent = card.name || card.id || 'Unknown Card';
            tooltipType.textContent = 'Type: ' + (card.type || '—');
            tooltipColor.textContent = 'Color: ' + (card.color || '—');

            const effectiveCost = getEffectiveCost(card);
            tooltipCost.textContent = 'Cost: ' + (effectiveCost !== null ? effectiveCost : '—');

            cardTooltip.style.display = 'block';
            moveCardTooltip(event);
        }

        function moveCardTooltip(event) {
            if (cardTooltip.style.display === 'none') return;

            const padding = 12;
            let x = event.clientX + padding;
            let y = event.clientY + padding;

            const tooltipRect = cardTooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            if (x + tooltipRect.width > viewportWidth - 8) {
                x = viewportWidth - tooltipRect.width - 8;
            }
            if (y + tooltipRect.height > viewportHeight - 8) {
                y = viewportHeight - tooltipRect.height - 8;
            }

            cardTooltip.style.left = x + 'px';
            cardTooltip.style.top = y + 'px';
        }

        function hideCardTooltip() {
            cardTooltip.style.display = 'none';
        }

        function showCardImage(cardId, elem) {
            cardPreview.style.display = 'block';
            cardPreview.src = `vibes_card_images/${cardId}.png`;

            cardPreview.onload = () => {
                positionCardImage(cardPreview, elem);
            };
        }

        function positionCardImage(img, elem) {
            const rect = elem.getBoundingClientRect();
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            const offsetX = 20;
            const imageHeight = img.offsetHeight || 380;

            let top = rect.top + scrollTop;
            let left = rect.right + scrollLeft + offsetX;

            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            if (top + imageHeight > scrollTop + viewportHeight) {
                top = scrollTop + viewportHeight - imageHeight - 10;
            }

            img.style.top = top + 'px';
            img.style.left = left + 'px';
        }

        function hideCardImage() {
            cardPreview.style.display = 'none';
            cardPreview.src = '';
        }

        function renderDeck(input) {
            const deckGrid = document.getElementById("cardGrid");
            const deckNameEl = document.getElementById("deckName");
            const deckCountEl = document.getElementById("deckCountDisplay");

            deckGrid.innerHTML = "";
            deckNameEl.textContent = "";
            deckCountEl.textContent = "";
            hideCardTooltip();
            hideCardImage();

            try {
                const deckData = JSON.parse(input);

                lastDeckJSON = JSON.stringify(deckData);

                const { deckName, counts } = deckData;

                deckNameEl.textContent = deckName || "Untitled";

                const totalCards = Object.values(counts || {}).reduce((sum, n) => sum + (n || 0), 0);
                deckCountEl.textContent = totalCards ? `${totalCards} cards` : "";

                for (const [cardId, count] of Object.entries(counts || {})) {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.dataset.cardId = cardId;

                    const img = document.createElement('img');
                    img.src = `vibes_card_images/${cardId}.png`;
                    img.alt = cardId;

                    const label = document.createElement('p');
                    label.textContent = `x${count}`;

                    cardDiv.append(img, label);
                    deckGrid.append(cardDiv);

                    cardDiv.addEventListener('mouseenter', (e) => {
                        showCardTooltip(cardId, e);
                        showCardImage(cardId, cardDiv);
                    });
                    cardDiv.addEventListener('mousemove', moveCardTooltip);
                    cardDiv.addEventListener('mouseleave', () => {
                        hideCardTooltip();
                        hideCardImage();
                    });
                }

                renderCharts(counts || {});
            } catch (e) {
                console.error(e);
                alert('Invalid JSON. Please check your input and try again.');
            }
        }

        let typeChart, colorChart, costChart;

        function renderCharts(counts) {
            const typeCounts = {};
            const colorCounts = {};
            const costList = [];

            for (const [cardId, qty] of Object.entries(counts)) {
                const card = allCards.find(c => c.id === cardId);
                if (!card) continue;

                typeCounts[card.type] = (typeCounts[card.type] || 0) + qty;

                if (card.color) {
                    const colors = card.color.split(',').map(c => c.trim()).filter(Boolean);
                    if (colors.length === 0) {
                        colorCounts['Colorless'] = (colorCounts['Colorless'] || 0) + qty;
                    } else {
                        colors.forEach(color => {
                            colorCounts[color] = (colorCounts[color] || 0) + qty;
                        });
                    }
                } else {
                    colorCounts['Colorless'] = (colorCounts['Colorless'] || 0) + qty;
                }

                if ((card.type === 'Penguin' || card.type === 'Relic') && card.cost && card.cost.amount != null) {
                    for (let i = 0; i < qty; i++) {
                        costList.push(card.cost.amount);
                    }
                }
            }

            const costCounts = {};
            costList.forEach(val => {
                costCounts[val] = (costCounts[val] || 0) + 1;
            });

            const costLabels = Object.keys(costCounts).sort((a, b) => a - b);
            const costData = costLabels.map(l => costCounts[l]);

            [typeChart, colorChart, costChart].forEach(c => c && c.destroy());

            const ctxType = document.getElementById('typeChart').getContext('2d');
            typeChart = new Chart(ctxType, {
                type: 'bar',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        label: 'Count by Type',
                        data: Object.values(typeCounts)
                    }]
                }
            });

            const ctxColor = document.getElementById('colorChart').getContext('2d');
            colorChart = new Chart(ctxColor, {
                type: 'bar',
                data: {
                    labels: Object.keys(colorCounts),
                    datasets: [{
                        label: 'Count by Color',
                        data: Object.values(colorCounts)
                    }]
                }
            });

            const ctxCost = document.getElementById('costChart').getContext('2d');
            costChart = new Chart(ctxCost, {
                type: 'bar',
                data: {
                    labels: costLabels,
                    datasets: [{
                        label: 'Penguin/Relic Cost Distribution',
                        data: costData
                    }]
                }
            });
        }

        function openInDeckBuilder() {
            if (!lastDeckJSON) {
                alert('No deck loaded yet. Paste a deck code and click Submit first.');
                return;
            }
            const url = 'deckbuilder.html?deck=' + encodeURIComponent(lastDeckJSON);
            window.open(url, '_blank');
        }

        (async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('deck')) {
                const raw = params.get('deck') || '';
                const deckJson = decodeURIComponent(raw);
                deckInput.value = deckJson;
                await cardsReady;
                renderDeck(deckJson);
            }
        })();
        // Add comments here
        // and here so the number of lines of code ends in 69, which is a fun and good number.

    </script>
</body>
</html>
